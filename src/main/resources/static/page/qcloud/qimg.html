<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>腾讯云万象优图</title>
    <script type="text/javascript" src="/script/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/script/jquery.form-3.51.0.min.js"></script>
</head>
<body>
<div>
    <h2>腾讯云万象优图</h2>
    <form id="uploadForm">
        <input type="file" name="FileContent" accept="image/png,image/gif,image/png"/>
        <input id="subbtn" type="submit" value="上传"/>
    </form>

    <div id="downloadRet">
        <h3>下载链接</h3>
        <span id="downloadUrl"></span><input id="downloadBtn" type="button" value="下载"><br/>
        <img id="downloadImg" src="" alt=""/>
        <h3>文件ID</h3>
        <div id="fileid"></div>
        <h3>管理URL</h3>
        <span id="url"></span>
        <input id="queryBtn" type="button" value="查询"/>
        <input id="deleteBtn" type="button" value="删除"/>
        <input id="copyBtn" type="button" value="复制"/><br/>
        <span id="imgInfo"></span>
    </div>
</div>


<script type="text/javascript">

    $(document).ready(function () {
        initUploadForm();
    });

    $('input[name=FileContent]').change(function () {
        var file = this.files[0];
        name = file.name;
        size = file.size;
        type = file.type;
        console.log("File name:" + name + ";size:" + size + "(" + (size / 1024 / 1024) + "M);type:" + type)
        initUploadForm();
    });

    $('body').on('click', '#downloadBtn', function () {
        $('#downloadImg').attr('src', $('#downloadUrl').text());
    });

    $('body').on('click', '#deleteBtn', function () {
        var manageUrl = $('#url').text();
        if (!manageUrl) {
            alert('尚未获取管理url');
            return false;
        }
        manageUrl = manageUrl + '/del';
        // 请将以下获取签名的链接换成您部署好的服务端http url
        // 建议通过业务登陆态检查来增强安全性，避免签名被非法获取
        $.getJSON('http://localhost:8888/qc/getsign?type=delete&fileid=' + $("#fileid").text() + '&url=' + encodeURIComponent(manageUrl),
                function (data) {
                    console.log(data);
                    var sign = data.sign,
                            url = manageUrl + '?sign=' + encodeURIComponent(sign);
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: {},
                        success: function () {
                            alert('删除成功');
                        },
                        contentType: "multipart/form-data",
                        dataType: 'json'
                    });
                });
    });

    $('body').on('click', '#copyBtn', function () {
        var manageUrl = $('#url').text();
        if (!manageUrl) {
            alert('尚未获取管理url');
            return false;
        }
        manageUrl = manageUrl + '/copy';
        // 请将以下获取签名的链接换成您部署好的服务端http url
        // 建议通过业务登陆态检查来增强安全性，避免签名被非法获取
        $.getJSON('http://localhost:8888/qc/getsign?type=copy&fileid=' + $("#fileid").text() + '&url=' + encodeURIComponent(manageUrl),
                function (data) {
                    console.log(data);
                    var sign = data.sign,
                            url = manageUrl + '?sign=' + encodeURIComponent(sign);
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: {},
                        success: function (ret) {
                            alert('复制成功');
                        },
                        contentType: "multipart/form-data",
                        dataType: 'json'
                    });
                });
    });

    $('body').on('click', '#queryBtn', function () {
        var manageUrl = $('#url').text();
        if (!manageUrl) {
            alert('尚未获取管理url');
            return false;
        }
        $.ajax({
            type: "GET",
            url: manageUrl,
            data: {},
            success: function (data) {
                $('#imgInfo').text(JSON.stringify(data));
            },
            error: function (ret) {
                $('#imgInfo').text(ret.responseText);
            },
            dataType: 'json'
        });
    });

    function initUploadForm() {
        // 请将以下获取签名的链接换成您部署好的服务端http url
        // 建议通过业务登陆态检查来增强安全性，避免签名被非法获取
        $.getJSON('http://localhost:8888/qc/getsign?type=upload', function (data) {
            var sign = data.sign,
                    url = data.url + '?sign=' + encodeURIComponent(sign);
            var options = {
                type: 'post',
                url: url,
                dataType: 'json',
                xhr: function () { // custom xhr
                    myXhr = $.ajaxSettings.xhr();
                    if (myXhr.upload) { // check if upload property exists
                        myXhr.upload.addEventListener('progress', progressHandlingFunction, false); // for handling the progress of the upload
                    }
                    return myXhr;
                },
                success: function (ret) {
                    $('#downloadUrl').html(ret.data.download_url);
                    $('#fileid').text(ret.data.fileid);
                    $('#url').text(ret.data.url);
                    $('#downloadRet').show();
                },
                error: function (ret) {
                    alert(ret.responseText);
                }
            };

            // pass options to ajaxForm
            $('#uploadForm').ajaxForm(options);
        });
    }
    function progressHandlingFunction(e) {
        if (e.lengthComputable) {
            console.log("loaded:" + e.loaded + ";total:" + e.total)
        }
    }
</script>
</body>
</html>